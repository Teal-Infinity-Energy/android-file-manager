# OneTap - Android Setup Guide

## Prerequisites

- **Node.js** v20+
- **JDK 21** (required for Android/Gradle)
- **Android Studio** with Android SDK
- **Android phone** (8.0+) with USB debugging enabled

## Quick Start

### 1. Clone & Install

```bash
git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git
cd YOUR_REPO
npm install
```

### 2. Build Android Project

**Option A: Clean Rebuild (Recommended)**

Use the automated script for a complete rebuild:

```bash
node scripts/android/clean-rebuild-android.mjs
```

This single command:
1. Deletes existing `android/` folder
2. Adds Android platform (`npx cap add android`)
3. Applies all native patches
4. Syncs the project (`npx cap sync android`)

**Option B: Manual Steps**

```bash
npx cap add android
npm run build
npx cap sync android
node scripts/android/patch-android-project.mjs
```

### 3. Run on Device

```bash
# Enable USB debugging on your phone first
npx cap run android
```

Or use the combined command:

```bash
node scripts/android/clean-rebuild-android.mjs --run
```

## Build Scripts Reference

| Script | Description |
|--------|-------------|
| `node scripts/android/clean-rebuild-android.mjs` | Full rebuild: delete, add, patch, sync |
| `node scripts/android/clean-rebuild-android.mjs --run` | Rebuild and run on device |
| `node scripts/android/clean-rebuild-android.mjs --verify` | Rebuild and verify Gradle build |
| `node scripts/android/clean-rebuild-android.mjs --release` | Rebuild and build release AAB |
| `node scripts/android/clean-rebuild-android.mjs --warning-mode` | Check for Gradle deprecations |
| `node scripts/android/clean-rebuild-android.mjs --skip-sync` | Rebuild without final sync |
| `node scripts/android/patch-android-project.mjs` | Apply patches only (without rebuild) |

### What the Patch Script Does

The `patch-android-project.mjs` script applies **Gradle 9/10 compatible** configurations:

- **Copies native files** from `native/android/` to `android/`
  - Custom Java files (MainActivity, ShortcutPlugin, VideoPlayer, etc.)
  - AndroidManifest.xml customizations
  - Resource files and layouts
- **Updates Gradle** wrapper to 8.13 (Gradle 9/10 ready)
- **Configures SDK versions**: minSdk=31, compileSdk=36, targetSdk=36
- **Uses modern Gradle DSL syntax**
- **Sets JDK 21** in gradle.properties
- **Adds dependencies**: SwipeRefreshLayout, ExoPlayer/Media3, RecyclerView, ExifInterface
- **Removes deprecated patterns**: jcenter(), old dependency configurations
- **Configures release signing** with environment variables

## After Code Changes

```bash
git pull
npm run build
npx cap sync android
node scripts/android/patch-android-project.mjs  # If native files changed
npx cap run android
```

Or simply run the clean rebuild:

```bash
node scripts/android/clean-rebuild-android.mjs --run
```

## Project Structure

```
native/android/           # Source native files (edit these)
├── app/src/main/java/   # Custom Java classes
├── app/src/main/res/    # Resources, layouts, drawables
└── app/src/main/AndroidManifest.xml

android/                  # Generated Capacitor project (don't edit)
├── ...                  # Files copied from native/android/ by patch script

scripts/android/
├── clean-rebuild-android.mjs  # Full rebuild automation
└── patch-android-project.mjs  # Apply patches only
```

**Important**: Always edit files in `native/android/`, not in `android/`. The `android/` folder is regenerated by the build scripts.

## Configure OAuth (Required for Google Sign-In)

The app uses **Android App Links** for OAuth callback. This requires HTTPS URLs on your production domain.

### Step 1: Supabase Setup

1. Go to your [Supabase dashboard](https://supabase.com/dashboard)
2. Navigate to **Authentication → URL Configuration**
3. Add to "Redirect URLs": `https://onetapapp.in/auth-callback`

### Step 2: Environment Variable

Ensure your `.env` file contains:
```
VITE_PRODUCTION_DOMAIN=onetapapp.in
```

### Step 3: Domain Verification (assetlinks.json)

The file hosted at `https://onetapapp.in/.well-known/assetlinks.json` must contain your app's signing certificate fingerprint.

```bash
# Get your debug keystore fingerprint:
keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android | grep SHA256

# Get your release keystore fingerprint:
keytool -list -v -keystore your-release.keystore -alias your-alias | grep SHA256
```

For production, use the SHA-256 fingerprint from Google Play Console → Setup → App signing → App signing key certificate.

### Step 4: AndroidManifest.xml

The `native/android/app/src/main/AndroidManifest.xml` already declares the App Link intent filter for `onetapapp.in`. If you use a different domain, update the `android:host` value.

## OAuth Deep Link Flow (App Links)

1. User taps "Sign in with Google"
2. App opens Google OAuth in Chrome Custom Tab
3. After authentication, Google redirects to `https://onetapapp.in/auth-callback?code=...`
4. Android intercepts this HTTPS URL (via verified App Link in AndroidManifest.xml)
5. App exchanges the code for a session token
6. User is signed in

**Files involved:**
- `assetlinks.json` on your website - Domain verification for App Links
- `native/android/app/src/main/AndroidManifest.xml` - App Links intent-filter with `autoVerify="true"`
- `src/hooks/useDeepLink.ts` - Handles `appUrlOpen` events
- `src/hooks/useAuth.ts` - Native OAuth flow with `skipBrowserRedirect`

## Testing App Links on Physical Devices

```bash
# Check if Android verified the domain
adb shell pm get-app-links app.onetap.shortcuts

# Test the deep link manually
adb shell am start -W -a android.intent.action.VIEW \
  -d "https://onetapapp.in/auth-callback?code=test"

# Force re-verification
adb shell pm verify-app-links --re-verify app.onetap.shortcuts
```

## Environment Check

```bash
java -version      # Should be 21.x
echo $JAVA_HOME    # Should point to JDK 21
echo $ANDROID_HOME # Should be set
adb devices        # Should list your device
```

## Troubleshooting

| Issue | Fix |
|-------|-----|
| Device not detected | Enable USB debugging, check cable |
| Java version error | Install JDK 21, set as default |
| Build fails | Run `node scripts/android/clean-rebuild-android.mjs` |
| Method signature mismatch | Run clean rebuild to sync native files |
| Shortcuts not working | Requires Android 8.0+ |
| `spawn ./gradlew ENOENT` | See Gradlew fix below |
| OAuth goes to browser | Check assetlinks.json and App Links verification |
| "ES256 invalid signing" | Redirect URL not configured in Supabase Auth settings |
| Gradle deprecation warnings | Run `--warning-mode` flag to check, patch script fixes these |

### Gradlew Not Found Fix

```bash
cd android
gradle wrapper
cd ..
npx cap run android
```

### Java Toolchain Error (Looking for Java 21)

```bash
# Ubuntu/Debian
sudo apt install openjdk-21-jdk -y
export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64

# Then rebuild
node scripts/android/clean-rebuild-android.mjs --run
```

### App Links Not Working

If Google sign-in completes but opens in the browser instead of the app:

1. **Check assetlinks.json is accessible:**
   Visit `https://onetapapp.in/.well-known/assetlinks.json` in a browser

2. **Verify fingerprint matches:**
   ```bash
   keytool -list -v -keystore ~/.android/debug.keystore -alias androiddebugkey -storepass android | grep SHA256
   ```
   Compare with the fingerprint in `assetlinks.json`

3. **Check App Links verification status:**
   ```bash
   adb shell pm get-app-links app.onetap.shortcuts
   ```
   Look for `verified` status

4. **Force re-verification:**
   ```bash
   adb shell pm verify-app-links --re-verify app.onetap.shortcuts
   ```

## Release APK

1. `npx cap open android`
2. Build → Generate Signed Bundle/APK → APK
3. Find APK in `android/app/release/`

**Important:** Add your release keystore SHA256 fingerprint to `assetlinks.json` on your website domain before releasing.
